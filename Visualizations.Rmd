---
title: "Recent Advances in Interactive Visualizations in R"
author: "Jean V. Adams"
date: "13 Jan 2016"
output:
  html_document:
    toc: TRUE
    toc_depth: 1
    number_sections: true
    theme: cerulean
    highlight: tango
subtitle: USGS-GLSC All Hands Meeting
---

```{r setup, echo=FALSE} 
library(knitr) 
opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE)

# define two variables to keep track of Table and Figure numbers
tabcount <- 1
figcount <- 1
```




# HTML widgets for R

## HTML widgets produce interactive web visualizations. 

A few lines of R code is all it takes. 

I will walk through some examples of:

* Data table - interactive tabular data display   
* Leaflet - interactive geo-spatial mapping  
* D3 heatmap - interactive heatmap (bivariate grouping)  

This presentation is available at my GitHub site, in the **vizzy** repository,

** https://github.com/JVAdams/vizzy **

## What you need:

 * R - [download](https://cran.r-project.org/bin/windows/base/R-3.2.3-win.exe) and install
 * Packages - install

```{r, eval=FALSE}
install.packages(c(
  "DT",
  "leaflet",
  "d3heatmap"
)
```

For more information, visit the HTML widgets [showcase](http://www.htmlwidgets.org/showcase_leaflet.html).



# Read in the data

I will use historical data from the Lake Huron bottom trawl survey to demonstrate the capabilities of HTML widgets for R.

```{r, echo=FALSE}
setwd("C:/JVA/GitHub/vizzy")
datadir <- "C:/JVA/Lakes Vessels/Huron/2012/"

op <- read.csv(paste0(datadir, "HURON_OP.csv"), as.is=TRUE, 
  col.names=c("opid", "year", "vessel", "serial", "lake", "port", "cruise", 
    "opdate", "time", "lat", "long", "surftemp", "weather", "windspeed", 
    "seacond", "winddirect", "distance"))
numvars <- c("lat", "long", "surftemp", "weather", "windspeed", "seacond", 
  "winddirect", "distance")
op[, numvars] <- apply(op[, numvars], 2, as.numeric)
fixcoord <- function(ddmm., r=4) {
  dd <- floor(ddmm./100)
  mm. <- ddmm. - 100*dd
  dd. <- dd + mm./60
  round(dd., r)
  return(dd.)
}
op$long <- -fixcoord(op$long)
op$lat <- fixcoord(op$lat)
op$opdate <- as.Date(op$opdate, "%d-%b-%y")
sel <- !apply(is.na(op[, c("lat", "long")]), 1, any) & op$year %in% 2006:2010
op <- op[sel, c("opid", "year", "vessel", "cruise", "serial", "port", "opdate", "time", "lat", "long", "surftemp")]

trop <- read.csv(paste0(datadir, "HURON_TROP.csv"), as.is=TRUE, 
  col.names=c("opid", "towtime", "fishtemp", "depth", "trdesign"))
trop$fishtemp <- as.numeric(trop$fishtemp)

optrop <- merge(op, trop[, c("opid", "towtime", "fishtemp", "depth")])

cat <- read.csv(paste0(datadir, "HURON_TRCATCH.csv"), as.is=TRUE, 
  col.names=c("opid", "stage", "species", "n", "weight", "lfn"))
numvars <- c("stage", "weight", "lfn")
cat[, numvars] <- apply(cat[, numvars], 2, as.numeric)
optrcat <- merge(optrop, cat)

save(optrop, optrcat, file="Huron0610.RData")
rm(list = ls(name = ".GlobalEnv"), pos = ".GlobalEnv")
```

If you wish to try out the examples I am demonstrating today, download the data from my GitHub site using the commands below.  You will see that the file contains two objects: the bottom trawl operations data, **optrop**, and catch data, **optrcat**.

```{r}
huron.url <- "https://github.com/JVAdams/vizzy/raw/master/Huron0610.RData"
load(url(huron.url), verbose=TRUE)
```



# Data tables - Tabular data display  

Data table display R matrices or data frames as interactive HTML tables that support filtering, pagination, and sorting.

Let's take a look at the bottom trawl operations data.

```{r}
library(DT)
datatable(optrop)
```


```{r}
library(DT)
selvars <- c("opid", "year", "vessel", "cruise", "serial", "port", "opdate", 
  "fishtemp", "depth")
datatable(optrop[, selvars], options=list(pageLength=5), rownames=FALSE, 
  caption="Example DataTables", filter="top")
```



# **Leaflet** - Geo-spatial mapping  

**Leaflet** is a JavaScript library for creating dynamic maps that support panning and zooming along with various annotations like markers, polygons, and popups.

```{r}
library(leaflet)
leaflet(optrop) %>% 
  addTiles() %>%
  addCircleMarkers(lng=~long, lat=~lat)
```

## Make the map bigger.

```{r}
leaflet(optrop, width=1000, height=600) %>% 
  addTiles() %>%
  addCircleMarkers(lng=~long, lat=~lat)
```

## Color the symbols by depth.

```{r}
numpal <- colorNumeric("Blues", NULL)
leaflet(optrop) %>% 
  addTiles() %>%
  addCircleMarkers(lng=~long, lat=~lat, color=~numpal(depth))
```

## Add a legend.

```{r}
leaflet(optrop) %>% 
  addTiles() %>%
  addCircleMarkers(lng=~long, lat=~lat, color=~numpal(depth)) %>%
  addLegend("bottomleft", pal=numpal, values=~depth, opacity=1,
    title="Bottom depth  (m)")
```

## Highlight one year.

```{r}
facpal <- colorFactor(c("blue", "orange"), NULL)
leaflet(optrop) %>% 
  addTiles() %>%
  addCircleMarkers(lng=~long, lat=~lat, color=~facpal(year==2010))
```

## Provide a toggle for that one year.

```{r}
leaflet(optrop) %>% 
  addTiles() %>%
  addCircleMarkers(lng=~long[year!=2010], lat=~lat[year!=2010], 
    group="2006-2009") %>% 
  addCircleMarkers(lng=~long[year==2010], lat=~lat[year==2010], 
    group="2010") %>%   
  addLayersControl(overlayGroups=c("2006-2009", "2010"),
    options=layersControlOptions(collapsed=FALSE))
```

## Show the opid when you click on a point.

```{r}
leaflet(optrop) %>% 
  addTiles() %>%
  addCircleMarkers(lng=~long, lat=~lat, popup=~as.character(opid))
```

## Use a different background map.

```{r}
leaflet(optrop) %>% 
  addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(lng=~long, lat=~lat)
```




# d3heatmap - Interactive heatmaps with D3  

Interactive heatmaps with D3 including support for row/column highlighting and zooming.

```{r}
pd <- with(optrcat, tapply(n, list(port + depth/1000, species), mean))
pd[is.na(pd)] <- 0
pd <- sqrt(pd)

library(d3heatmap)
d3heatmap(pd)
```

## Increase size.

```{r}
d3heatmap(pd, width=900, height=600)
```

## Increase font size.

```{r}
d3heatmap(pd, cexRow=2, cexCol=2)
```

## Change colors.

```{r}
d3heatmap(pd, colors="Blues")
```

## Change column order.

```{r}
d3heatmap(pd, Colv=FALSE)
```

## Change row order.

```{r}
d3heatmap(pd, Rowv=FALSE)
```


